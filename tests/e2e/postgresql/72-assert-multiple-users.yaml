apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 1800
commands:
  - script: |
      JOB_NAME=connect-postgresql-multiple-users
      TIMEOUT_SECONDS=600

      start_time=$(date +%s)
      while true; do
        current_time=$(date +%s)
        elapsed_time=$((current_time - start_time))

        if [ $elapsed_time -ge $TIMEOUT_SECONDS ]; then
          echo "Timeout waiting for Job $JOB_NAME."
          break
        fi

        # Check if the Job is complete
        if kubectl -n "$NAMESPACE" wait --for=condition=complete job/$JOB_NAME --timeout=1s; then
          echo "Job $JOB_NAME completed successfully."
          break
        fi

        # Check if the Job has failed
        if kubectl -n "$NAMESPACE" wait --for=condition=failed job/$JOB_NAME --timeout=1s; then
          echo "Job $JOB_NAME failed."
          break
        fi

        sleep 5
      done

      echo "--- Logs from connect-postgresql-multiple-users pod ($POD_NAME) ---"
      kubectl -n "$NAMESPACE" logs -l job-name=connect-postgresql-multiple-users
      echo "--- End of Logs ---"

      if kubectl -n "$NAMESPACE" wait --for=condition=complete job/$JOB_NAME --timeout=1s; then
        echo "Job 'connect-postgresql-multiple-users' completed successfully."
        exit 0
      else
        echo "Job 'connect-postgresql-multiple-users' failed." >&2
        exit 1
      fi
