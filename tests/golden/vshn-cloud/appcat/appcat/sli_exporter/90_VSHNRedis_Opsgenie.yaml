apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    syn: 'true'
    syn_component: appcat
    syn_team: schedar
  name: vshn-vshnredis-sla
  namespace: syn-appcat-slos
spec:
  groups:
    - name: appcat-vshnredis-sla-target
      rules:
        - alert: VSHNRedisSla
          annotations:
            summary: '{{$labels.service}} {{$labels.name}} down in {{$labels.namespace}}'
            title: '{{$labels.service}} {{$labels.name}} down in {{$labels.namespace}}'
          expr: rate(appcat_probes_seconds_count{reason!="success", service="VSHNRedis",
            ha="false", maintenance="false"}[5m]) > 0.4
          labels:
            OnCall: '{{ if eq $labels.sla "guaranteed" }}true{{ else }}false{{ end
              }}'
            runbook: https://kb.vshn.ch/app-catalog/how-tos/appcat/GuaranteedUptimeTarget.html
            service: VSHNRedis
            severity: critical
            syn: 'true'
            syn_component: appcat
            syn_team: schedar
        - alert: VSHNRedisSlaHA
          annotations:
            summary: '{{$labels.service}} {{$labels.name}} down in {{$labels.namespace}}'
            title: '{{$labels.service}} {{$labels.name}} down in {{$labels.namespace}}'
          expr: rate(appcat_probes_seconds_count{reason!="success", service="VSHNRedis",
            ha="true"}[5m]) > 0.4
          labels:
            OnCall: '{{ if eq $labels.sla "guaranteed" }}true{{ else }}false{{ end
              }}'
            runbook: https://kb.vshn.ch/app-catalog/how-tos/appcat/GuaranteedUptimeTarget.html
            service: VSHNRedis
            severity: critical
            syn: 'true'
            syn_component: appcat
            syn_team: schedar
        - expr: vector(99.25)
          labels:
            service: VSHNRedis
          record: sla:objective:ratio
        - alert: VSHNRedisNotMaster
          annotations:
            description: Service {{ $labels.service }} is not connected to a master
              for 5m.
            summary: 'Redis not master: {{ $labels.name }} ({{ $labels.namespace }})'
          expr: appcat_probes_redis_ha_master_up{ha="true"} == 0
          for: 5m
          labels:
            OnCall: '{{ if eq $labels.sla "guaranteed" }}true{{ else }}false{{ end
              }}'
            service: VSHNRedis
            severity: critical
            syn: 'true'
            syn_component: appcat
            syn_team: schedar
        - alert: VSHNRedisQuorumNotOk
          annotations:
            description: Quorum failing for 5m.
            summary: 'Redis quorum not OK: {{ $labels.name }} ({{ $labels.namespace
              }})'
          expr: |
            appcat_probes_redis_ha_master_up{ha="true"} == 1
            and on(service,namespace,name,organization,ha,sla)
            appcat_probes_redis_ha_quorum_ok{ha="true"} == 0
          for: 5m
          labels:
            OnCall: false
            service: VSHNRedis
            severity: warning
            syn: 'true'
            syn_component: appcat
            syn_team: schedar
        - alert: VSHNRedisQuorumFlapping
          annotations:
            description: Quorum state flipped {{ $value }} times in 10m.
            summary: 'Redis quorum flapping: {{ $labels.name }} ({{ $labels.namespace
              }})'
          expr: |
            appcat_probes_redis_ha_master_up{ha="true"} == 1
            and on(service,namespace,name,organization,ha,sla)
            changes(appcat_probes_redis_ha_quorum_ok{ha="true"}[10m]) >= 4
          labels:
            OnCall: false
            service: VSHNRedis
            severity: warning
            syn: 'true'
            syn_component: appcat
            syn_team: schedar
