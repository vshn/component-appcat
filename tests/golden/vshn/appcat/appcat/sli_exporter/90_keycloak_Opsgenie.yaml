apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    syn: 'true'
    syn_component: appcat
    syn_team: schedar
  name: vshn-keycloak-guaranteed-uptime
  namespace: appcat-slos
spec:
  groups:
    - name: appcat-keycloak-guaranteed-uptime-target
      rules:
        - alert: vshn-keycloak-guaranteed-uptime
          expr: rate(appcat_probes_seconds_count{reason!="success", service="keycloak",
            ha="false", maintenance="false"}[5m]) > 0.2 and rate(appcat_probes_seconds_count{reason!="success",
            service="keycloak", ha="false", maintenance="false"}[1m]) > 0.75
          labels:
            OnCall: '{{ if eq $labels.sla "guaranteed" }}true{{ else }}false{{ end
              }}'
            runbook: https://kb.vshn.ch/app-catalog/how-tos/appcat/GuaranteedUptimeTarget.html
            service: keycloak
            severity: critical
            syn: 'true'
            syn_component: appcat
            syn_team: schedar
        - alert: vshn-keycloak-sla-ha
          expr: rate(appcat_probes_seconds_count{reason!="success", service="keycloak",
            ha="true"}[5m]) > 0.2 and rate(appcat_probes_seconds_count{reason!="success",
            service="keycloak", ha="true"}[1m]) > 0.75
          labels:
            OnCall: '{{ if eq $labels.sla "guaranteed" }}true{{ else }}false{{ end
              }}'
            runbook: https://kb.vshn.ch/app-catalog/how-tos/appcat/GuaranteedUptimeTarget.html
            service: keycloak
            severity: critical
            syn: 'true'
            syn_component: appcat
            syn_team: schedar
