classes:
  - .common

parameters:
  pkg.appcat.composition.objectstorage.exoscale:
    secretNamespaces:
      iamkeys: syn-provider-exoscale-secrets
    bucketDeletionPolicy: DeleteAll

  appcat:
    compositions:
      "exoscale.objectbuckets.appcat.vshn.io":
        commonPatchSets:
          annotations: {}
          labels: {}
        commonResources:
          observeClaimNamespace: {}
        spec:
          compositeTypeRef:
            apiVersion: appcat.vshn.io/v1
            kind: XObjectBucket
          writeConnectionSecretsToNamespace: ${crossplane:namespace}
          resources:

            - base:
                apiVersion: exoscale.crossplane.io/v1
                kind: IAMKey
                metadata: {} # patched
                spec:
                  forProvider:
                    keyName: "" # patched
                    # The zone is exposed as region in XRD
                    zone: "" # patched
                    services:
                      sos:
                        buckets:
                          - "" # patched
                  writeConnectionSecretToRef:
                    name: "" # patched
                    namespace: ${pkg.appcat.composition.objectstorage.exoscale:secretNamespaces:iamkeys}
                  providerConfigRef:
                    name: exoscale
              connectionDetails:
                - fromConnectionSecretKey: AWS_ACCESS_KEY_ID
                  type: FromConnectionSecretKey
                  name: AWS_ACCESS_KEY_ID
                - fromConnectionSecretKey: AWS_SECRET_ACCESS_KEY
                  type: FromConnectionSecretKey
                  name: AWS_SECRET_ACCESS_KEY
              patches:
                - type: PatchSet
                  patchSetName: annotations
                - type: PatchSet
                  patchSetName: labels
                - type: FromCompositeFieldPath
                  fromFieldPath: metadata.labels[crossplane.io/composite]
                  toFieldPath: metadata.name
                - type: ToCompositeFieldPath
                  fromFieldPath: status.conditions
                  toFieldPath: status.accessUserConditions
                - type: FromCompositeFieldPath
                  fromFieldPath: metadata.labels[crossplane.io/composite]
                  toFieldPath: spec.writeConnectionSecretToRef.name
                # Set key name
                - type: CombineFromComposite
                  toFieldPath: spec.forProvider.keyName
                  combine:
                    variables:
                      - fromFieldPath: metadata.labels[crossplane.io/claim-namespace]
                      - fromFieldPath: metadata.labels[crossplane.io/claim-name]
                    strategy: string
                    string:
                      fmt: "%s.%s"
                # Set zone
                - type: FromCompositeFieldPath
                  fromFieldPath: spec.parameters.region
                  toFieldPath: spec.forProvider.zone
                # Set bucket
                - type: FromCompositeFieldPath
                  fromFieldPath: spec.parameters.bucketName
                  toFieldPath: spec.forProvider.services.sos.buckets[0]

            - base:
                apiVersion: exoscale.crossplane.io/v1
                kind: Bucket
                metadata: {} # patched
                spec:
                  forProvider:
                    bucketName: "" # patched
                    endpoint: "" # patched
                    endpointURL: "" # patched
                    # The zone is exposed as region in XRD
                    zone: "" # patched
                    bucketDeletionPolicy: ${pkg.appcat.composition.objectstorage.exoscale:bucketDeletionPolicy}
                  providerConfigRef:
                    name: exoscale
              connectionDetails:
                - fromFieldPath: spec.forProvider.endpoint
                  type: FromFieldPath
                  name: ENDPOINT
                - fromFieldPath: spec.forProvider.endpointURL
                  type: FromFieldPath
                  name: ENDPOINT_URL
                - fromFieldPath: spec.forProvider.zone
                  type: FromFieldPath
                  name: AWS_REGION
                - fromFieldPath: status.atProvider.bucketName
                  type: FromFieldPath
                  name: BUCKET_NAME
              patches:
                - type: PatchSet
                  patchSetName: annotations
                - type: PatchSet
                  patchSetName: labels
                - type: FromCompositeFieldPath
                  fromFieldPath: metadata.labels[crossplane.io/composite]
                  toFieldPath: metadata.name
                - type: ToCompositeFieldPath
                  fromFieldPath: status.conditions
                  toFieldPath: status.bucketConditions
                - type: FromCompositeFieldPath
                  fromFieldPath: spec.parameters.bucketName
                  toFieldPath: spec.forProvider.bucketName
                # Set endpoint
                - type: FromCompositeFieldPath
                  fromFieldPath: spec.parameters.region
                  toFieldPath: spec.forProvider.endpoint
                  transforms:
                    - type: string
                      string:
                        fmt: "sos-%s.exo.io"
                        type: Format
                - type: FromCompositeFieldPath
                  fromFieldPath: spec.parameters.region
                  toFieldPath: spec.forProvider.endpointURL
                  transforms:
                    - type: string
                      string:
                        fmt: "https://sos-%s.exo.io"
                        type: Format
                # Set region
                - type: FromCompositeFieldPath
                  fromFieldPath: spec.parameters.region
                  toFieldPath: spec.forProvider.zone

    additionalResources:
      provider-exoscale-secrets-iamkeys:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: ${pkg.appcat.composition.objectstorage.exoscale:secretNamespaces:iamkeys}

    secrets:
      exoscale-api-access:
        metadata:
          namespace: ${crossplane:namespace}
        stringData:
          EXOSCALE_API_KEY: '?{vaultkv:${cluster:tenant}/${cluster:name}/appcat/objectstorage/provider-exoscale/access-key}'
          EXOSCALE_API_SECRET: '?{vaultkv:${cluster:tenant}/${cluster:name}/appcat/objectstorage/provider-exoscale/secret-key}'

  crossplane:
    providerConfigs:
      exoscale:
        apiVersion: exoscale.crossplane.io/v1
        spec:
          credentials:
            source: InjectedIdentity
            apiSecretRef:
              name: exoscale-api-access
              namespace: ${crossplane:namespace}
